<!DOCTYPE html>
<html lang="en">
<head>
    <script type='text/javascript' src="/static/js/doc.js"></script>
    <script type='text/javascript' src="/static/js/aes.js"></script>
    <script type='text/javascript' src="/static/js/pbkdf2.js"></script>
    <script type='text/javascript' src="/static/js/sha256.js"></script>


    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script type="text/javascript" src="/static/ckeditor/ckeditor/ckeditor.js"></script>
    <script type="text/javascript" src="/static/ckeditor/ckeditor-init.js"></script>




    <link rel="stylesheet" type="text/css" href="/static/css/doc.css">
    <meta charset="UTF-8">
    <title>New Post</title>
</head>
<body>

    {% extends 'base.html' %}
    {% block content %}

    <h1>New Post!</h1>

    {%if error %}
        <div class="alert alert-danger" role="alert">
        {{ error }}
        </div>
    {% endif %}

    <form method="POST" action="{% url 'posts:create' %}">
        {% csrf_token %}

        <input type="text" name="title" placeholder="Title" />
        <br /><br />


        {% load wysiwyg %}
        {% wysiwyg_setup %}

        <textarea id="foo" name="document"></textarea>
        <input type="hidden" name="test" id="test">
        <input type="hidden" name="key" id="key">
        <input type="hidden" name="iv" id="iv">

        {% wysiwyg_editor "foo" %}

        <br/>

        <br/><br/>
        <button class="btn btn-primary" type="submit" value="Save" onclick="encrypt()">
            <span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span> Save
        </button>

    </form>


        <script type="text/javascript">

			function encrypt() {

			    var iv = new Uint32Array(1);
                iv = window.crypto.getRandomValues(iv);
                console.log("Rand is: " + iv[0]);

                var key = CryptoJS.SHA256(iv.toString());
                console.log("key is: " + key);

                var key2 = key.toString(CryptoJS.enc.Base64);
                console.log("Hash is: " + key2);

                var iv2 = iv.toString(CryptoJS.enc.Base64);
                console.log("iv2: " + iv2);

                document.getElementById("key").value = key2;
                document.getElementById("iv").value = iv2;

                var doc = CKEDITOR.instances["foo"].getData();
			    var encrypted = CryptoJS.AES.encrypt(doc, key2,  {iv: iv2});

                document.getElementById("test").value = encrypted;
                console.log("test is set to: " + encrypted);

                return false;
            }

        </script>

    {% endblock %}


</body>
</html>