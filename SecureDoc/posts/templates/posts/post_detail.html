<!DOCTYPE html>
<html lang="en">
<head>
    <script type='text/javascript' src="/static/js/doc.js"></script>
    <script type='text/javascript' src="/static/js/aes.js"></script>
    <link rel="stylesheet" type="text/css" href="/static/css/doc.css">
     <link rel="stylesheet" type="text/css" href="/static/css/post_detail.css">
    <meta charset="UTF-8">
    <title>Post Detail</title>
</head>
<body>

    {% extends 'base.html' %}

    {% block content %}

    <div class="container">
        <form method="POST" action="{% url 'posts:update' %}">
            {% csrf_token %}

            <input type="hidden" name="post_id" value={{post.id}} >
            <h3><input id="title" type="text" name="title" value="{{post.title}}"></h3>
            <br />

            {% load wysiwyg %}
            {% wysiwyg_setup %}

            <textarea id="foo" name="document"></textarea>
            <input type="hidden" name="test" id="test">

            {% wysiwyg_editor "foo" %}

            <br/>
            <button class="btn btn-primary" type="submit" value="Save" onclick="encrypt()">
              <span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span> Save
            </button>
        </form>

        <div class="row">
            <div class="col-md-6">
                <h3>Share with Friends</h3>
                <table class="table table-hover">
                    {% for user in users %}
                        <td>
                        <td>{{user.first.username}}</td>
                        <td class="text-right">
                            <form method="post" action="{% url 'posts:share_viewing' %}" name="share_viewing">
                                {% csrf_token %}
                                <input type="hidden" name="post_id_to_share" value={{post.id}} >
                                <input type="hidden" name="post_author" value={{post.author}} >
                                <input type="hidden" name="friend_username" value={{ user.first.username }} >
                                <input class="btn btn-primary" type="submit" value="Ability to View">
                            </form>
                        </td>
                        <td class="text-right">
                            <form method="post" action="{% url 'posts:share_editing' %}" name="share_editing">
                                {% csrf_token %}
                                <input type="hidden" name="post_id_to_share" value={{post.id}} >
                                <input type="hidden" name="post_author" value={{post.author}} >
                                <input type="hidden" name="friend_username" value={{ user.first.username }} >
                                <input class="btn btn-primary" type="submit" value="Ability to Edit">
                            </form>
                        </td>
                        <tr></tr>
                    {% endfor %}
                </table>
            </div>
        </div>
    </div>

        <script type="text/javascript">
            var key = CryptoJS.enc.Base64.parse("#base64Key#");
            var iv  = CryptoJS.enc.Base64.parse("#base64IV#");
            console.log("iv is: " + iv);
            var doc = "{{post.document|escapejs}}";

            var decrypted = CryptoJS.AES.decrypt(doc, key, {iv: iv});
            CKEDITOR.instances["foo"].setData(decrypted.toString(CryptoJS.enc.Utf8));

			function encrypt(){
			    var doc = CKEDITOR.instances["foo"].getData();
			    var encrypted = CryptoJS.AES.encrypt(doc, key,  {iv: iv});

                document.getElementById("test").value = encrypted;

                return false;
            }
        </script>



    {% endblock %}
</body>
</html>